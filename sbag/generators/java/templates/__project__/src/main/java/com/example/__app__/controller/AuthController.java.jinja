/// Generated from {{ self._TemplateReference__context.name | get_template_name_from_path }} by SBAG (https://github.com/vtanja/JSD)
/// on {{ date }}

package com.example.{{ app }}.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;
import com.example.{{ app }}.security.JwtTokenUtils;
import com.example.{{ app }}.model.User;
import com.example.{{ app }}.model.Role;
import com.example.{{ app }}.repository.UserRepository;
import com.example.{{ app }}.repository.RoleRepository;
import com.example.{{ app }}.dto.AuthRequestDTO;
import com.example.{{ app }}.dto.UserTokenStateDTO;
import com.example.{{ app }}.dto.RegistrationDTO;

import java.util.HashSet;
import java.util.Set;

@RestController
@RequestMapping(value = "/auth", produces = MediaType.APPLICATION_JSON_VALUE)
public class AuthController {

  @Lazy @Autowired AuthenticationManager authenticationManager;

  @Autowired JwtTokenUtils jwtTokenUtils;

  @Autowired UserRepository userRepository;

  @Lazy @Autowired PasswordEncoder passwordEncoder;

  @Autowired
  RoleRepository roleRepository;

   @PostMapping(path = "/login")
  public ResponseEntity<?> login(@RequestBody AuthRequestDTO request) throws Exception {

    System.out.println(request.getUsername() + " " + request.getPassword());
    try {
      Authentication authenticate =
          authenticationManager.authenticate(
              new UsernamePasswordAuthenticationToken(
                  request.getUsername(), request.getPassword()));

      SecurityContextHolder.getContext().setAuthentication(authenticate);

      Authentication loggedInUser = SecurityContextHolder.getContext().getAuthentication();

      User user = userRepository.findByUsername(loggedInUser.getName());
      String jwt = jwtTokenUtils.generateToken(user.getUsername());
      int experiesIn = jwtTokenUtils.getExpiredIn();
      String refresh = jwtTokenUtils.generateRefreshToken(user.getUsername());
      UserTokenStateDTO userTokenStateDTO = new UserTokenStateDTO(jwt,experiesIn,refresh, user.getUsername(), user.getRoles().iterator().next().getName());

      return new ResponseEntity<>(
              userTokenStateDTO, HttpStatus.ACCEPTED);
    } catch (Exception ex) {
        throw new Exception(ex.getMessage());
    }
  }

  @PostMapping(path="/register")
  public ResponseEntity<?> register(@RequestBody RegistrationDTO regDTO) throws Exception {
        var uUsername = userRepository.findByUsername(regDTO.getUsername());
        var uEmail = userRepository.findByEmail(regDTO.getEmail());
        if(uUsername != null || uEmail != null) {
            return new ResponseEntity<>(HttpStatus.BAD_REQUEST);
        }
        User user = new User();
        user.setEmail(regDTO.getEmail());
        user.setUsername(regDTO.getUsername());
        user.setPassword(passwordEncoder.encode(regDTO.getPassword()));

        Set<Role> rolesSet = new HashSet<>();

        if (userRepository.findAll().size() == 0){
          if (roleRepository.findByName("admin") == null){
            Role role = new Role();
            role.setName("admin");
            roleRepository.save(role);
          }
          rolesSet.add(roleRepository.findByName("admin"));
        }
        else{
          if (roleRepository.findByName("user") == null){
            Role role = new Role();
            role.setName("user");
            roleRepository.save(role);
          }
          rolesSet.add(roleRepository.findByName("user"));
        }
        
        user.setRoles(rolesSet);

        this.userRepository.save(user);

        return new ResponseEntity<>(HttpStatus.OK);
  }

}
